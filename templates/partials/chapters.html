{% set data_path = "content/chapters/" ~ page.slug ~ ".toml" %}
{% set episode_data = load_data(path=data_path) %}
{% set tile_size_tally = 0 %}
{% set last_rand = 0 %}

<section class="chapters">

  {% for chapter in episode_data.chapters %}

    {# Set image from static directory #}
    {% if chapter.image %}
      {%- set img_path = "../static" ~ page.path ~ chapter.image -%}
      {% if chapter.size >= 6 %}
        {%- set img = resize_image(path=img_path, width=800, quality=75, op='fit_width') -%}
      {% elif chapter.size >= 4 %}
        {%- set img = resize_image(path=img_path, width=600, quality=75, op='fit_width') -%}
      {% else %}
        {%- set img = resize_image(path=img_path, width=400, quality=75, op='fit_width') -%}
      {% endif %}
    {% endif %}

    {% if loop.first %}<div class="tile is-ancestor">{% endif %}
    {# Track tile sizes to intelligently create new rows #}
    {% if chapter.size %}
      {% set tile_size = chapter.size %}
    {% else %}
      {% set tile_size = 4 %}
    {% endif %}
    {% set_global tile_size_tally = tile_size_tally + tile_size %}
    {% if tile_size_tally >= 12 %}
      </div><div class="tile is-ancestor">
      {% set_global tile_size_tally = 0 %}
    {% endif %}

    <div class="tile has-text-centered is-parent is-{{ tile_size }}">
      {%- set rand = get_random(start=1, end=config.extra.color_options ) -%}
      {% if rand == last_rand %}
        {%- set rand = get_random(start=1, end=config.extra.color_options ) -%} # Reroll
      {% endif %}
      {% if rand == last_rand %}
        {%- set rand = get_random(start=1, end=config.extra.color_options ) -%} # Reroll
      {% endif %}
      <article class="card tile is-child palette-{{ rand }}">
        <div class="card-content">
          <h3 class="title is-size-5" onclick="chapterJump('{{ chapter.time }}');">
            {{ chapter.title }}
          </h3>
          <div class="chapter-jump">
            <div class="level">
              <h4 class="level-item tag is-size-6" onclick="chapterJump('{{ chapter.time }}');">
                Ch. {{ loop.index }}
              </h4>
              {% if tile_size > 3 %}
              <div class="level-item"></div>
              {% else %}
              {# Need to break level into rows if too small #}
            </div>
            <div class="level chapter-jump">
              {% endif %}
              <h4 class="level-item tag is-size-6" onclick="chapterJump('{{ chapter.time }}');">â–¶{{ chapter.time }}</h4>
            </div>
            {% if img %}
              <a href="{{ img_path }}" target="_blank" class="chapter-image">
                <img class="half-push-down" src="{{ img|safe }}">
              </a>
            {% endif %}
          </div>
          {% if chapter.credit %}
            <p class="subtitle">
              {% if chapter.link %}<a href="{{ chapter.link }}" target="_blank">{% endif %}
              <em>{{ chapter.credit }}</em>
              {% if chapter.link %}</a>{% endif %}
            </p>
          {% endif %}
        </div>
      </article>
    </div>

    {%- set last_rand = rand -%}
    {% if loop.last %}</div>{% endif %}

  {% endfor %}
</section>
